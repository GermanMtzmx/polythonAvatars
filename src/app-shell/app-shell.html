<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../bower_components/voice-elements/dist/voice-player.html">

<!-- local imports -->
<link rel="import" href="../app-login/app-login.html">
<link rel="import" href="../app-notfound/app-notfound.html">
<link rel="import" href="../app-home/app-home.html">
<link rel="import" href="../app-verification/app-verification.html">
<link rel="import" href="../app-map/app-map.html">

<link rel="import" href="../style-foundation/app-theme.html">
<script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.6.0/annyang.min.js"></script>




<dom-module id="app-shell">
    <template>
        <style>
            #header {
                @apply --toolbar-theme;
            }
        </style>
        
        <app-location route="{{route}}"></app-location>

        <app-route 
            route="{{route}}"
            pattern="/:page"
            data="{{routeData}}"
            tail="{{subroute}}"
        ></app-route>
        
        <voice-player id="polySiry" accent="es-MX" text="Bienvenido a lazme">            
        </voice-player>

        <app-header id="header" role="navigation" shadow$="[[isLogged]]">
            <app-toolbar class="toolbar">
                <template is="dom-if" if="[[isLogged]]">
                     <paper-icon-button on-tap="_goHome" id="previous" icon="icons:arrow-back"></paper-icon-button>                
                </template>
            </app-toolbar>
        </app-header>

        <iron-pages 
            role="main"
            attr-for-selected="id"
            selected="[[page]]"
            fallback-selection="notfound"
        >
            <app-login id="login"></app-login>
            <app-home id="home"></app-home>
            <app-notfound id="notfound"></app-notfound>
            <app-verification id="verification"></app-verification>
            <app-map id="map"></app-map>

            
        </iron-pages>
    </template>


    <script>
        (function Shell(customElements){
            'use strict';

            class AppShell extends Polymer.Element {
                static get is(){ return 'app-shell'; }

                static get properties(){
                    return {
                        route:{
                            type:Object,
                            value:{}  
                        },

                        subroute:{
                            type:Object,
                            value:{}
                        },

                        routeData:{
                            type:Object,
                            value:{}
                        },

                        page:{
                            type:String
                        },

                        isLogged:{
                            type:Boolean,
                            value:false
                        },

                        phrase:{
                            type:String,
                            value:''
                        }


                    }                    
                }



                static get observers(){
                    return [
                        '_routePageChanged(routeData.page)',
                        '_loggedChanged(isLogged)',
                        '_phraseChanged(phrase)'
                    ]
                }

                connectedCallback(){
                    super.connectedCallback();

                        navigator.getUserMedia (
                        // constraints
                           {
                              audio: true
                           },

                           // successCallback
                           function(localMediaStream) {
                            console.log('ok')
                           },

                           // errorCallback
                           function(err) {
                            console.log("The following error occured: " + err);
                           }

                        );

                        //this.$.polySiry.speak();



                   
                        var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition ||window.msSpeechRecognition)();
                        recognition.lang = 'es-MX'
                        recognition.continuous = true;
                        recognition.interimResults = false;
                        recognition.maxAlternatives = 1;
                        recognition.start();

                        recognition.onresult = (event) => {
                            console.log('You said: ', event.results);
                            if (event.results[event.results.length-1].isFinal){
                                this.phrase = String(event.results[event.results.length-1][0].transcript).toLowerCase();
                            }
                        };

                        recognition.onend = (e)=>{
                            console.log("ended");
                            //recognition.start();
                        }

                                          
                        
                    

                }

                _routePageChanged(page){
                    this.page = page || 'login';
                   if (this.page != 'login'){
                    this.isLogged = true;
                   }


                }

                _phraseChanged(phrase){

                    if(phrase.lenght <=0 ){
                        return
                    }
                    console.log('phrase was',phrase, 'phrase length', phrase.length);
                    
                    if(phrase == 'entrar' || phrase == ' entrar'){
                        this.set('routeData.page','home');
                        this.isLogged = true;
                    } else if(phrase == ' salir' || phrase == "salir ") {
                    
                        this.set('routeData.page','login');
                        this.isLogged = false;
                        this.$.polySiry.text = "Vuelve pronto";
                        this.$.polySiry.speak();

                    } else if(phrase == 'cajero' || phrase ==  ' cajero'){
                        this.page = 'map';
                        this.set('routeData.page', 'map');
                        this.$.polySiry.text = "Buscando un cajero cercano.";
                        this.$.polySiry.speak();
                    } else {
                        console.log('whaaat');
                    }
                }

                _goHome(){
                    this.page = "home";
                }

                _login(){
                    alert("loggginn")
                }

                _loggedChanged(loged){
                    if(loged){
                        this.set('route.path','home');
                    }else {
                        this.set('route.path','login');
                        
                        this.isLogged = loged;
                    }
                }


            }

            customElements.define(AppShell.is, AppShell);
        })(window.customElements);
    </script>
</dom-module>